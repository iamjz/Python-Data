Teapot: language support for writing memory coherence protocols