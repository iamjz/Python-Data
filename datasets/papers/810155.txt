Multi-level locking with deadlock avoidance